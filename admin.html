<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>时光酿造所 · 后台管理</title>
  <style>
    body {
      margin:0; font-family:'Segoe UI',sans-serif;
      background:#10141f; color:#f5f5f5;
    }
    header {background:#1b2230; padding:16px; font-size:20px; font-weight:bold; text-align:center;}
    main {padding:20px; max-width:1200px; margin:0 auto;}
    table {width:100%; border-collapse:collapse; margin-top:20px;}
    th,td {border:1px solid #333; padding:8px; text-align:center;}
    input,select {padding:6px; border:none; border-radius:4px; width:100%; box-sizing:border-box;}
    button {padding:10px 16px; border:none; border-radius:6px; background:#3a86ff; color:white; font-weight:bold; cursor:pointer; margin:5px;}
    button:hover {background:#5aa0ff;}
    #historyModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); z-index:999; justify-content:center; align-items:center;
    }
    #historyContent {
      background:#1b2230; padding:20px; border-radius:10px; max-height:80%; overflow:auto; width:90%; max-width:800px;
    }
    #historyContent h2 {margin-top:0;}
    #closeHistory {background:#ff5c8a;}
    #closeHistory:hover {background:#ff7da0;}
  </style>
</head>
<body>
  <header>后台管理 · 时光酿造所</header>
  <main>
    <section id="tableSection"></section>
    <button onclick="saveData()">保存配置</button>
    <button onclick="showHistory()">查看历史记录</button>
  </main>

  <!-- 历史记录弹窗 -->
  <div id="historyModal">
    <div id="historyContent">
      <h2>历史酿造记录</h2>
      <div id="historyTable"></div>
      <button id="closeHistory" onclick="closeHistory()">关闭</button>
    </div>
  </div>

  <script>
    const KEY='brew_dash_records_v1';
    const HISTORY_KEY='brew_history_v1';
    const tanks150=7, tanks75=2;

    function generateTable(){
      let html='<table><tr>' +
               '<th>展示</th><th>罐名</th><th>容量</th>' +
               '<th>酒名 / Name</th><th>风格 / Style</th>' +
               '<th>度数 / ABV</th><th>苦度 / IBU</th>' +
               '<th>产量 / Capacity</th><th>当前温度 / Temp</th>' +
               '<th>入罐时间 / Start</th><th>预计开罐 / End</th></tr>';

      for(let i=1;i<=tanks150;i++){
        const id=`F${i}`;
        html+=rowHTML(id,'150L');
      }
      for(let j=1;j<=tanks75;j++){
        const id=`实验款${j}`;
        html+=rowHTML(id,'75L',`${j}号实验罐`);
      }
      html+='</table>';
      document.getElementById('tableSection').innerHTML=html;

      const saved=loadAll();
      document.querySelectorAll('input,select').forEach(el=>{
        const id=el.dataset.id,key=el.dataset.key;
        if(saved[id] && saved[id][key]!==undefined){
          if(el.type==='checkbox'){el.checked=saved[id][key];}
          else el.value=saved[id][key];
        }
      });
    }

    function rowHTML(id,cap,displayName){
      const nameToShow = displayName || id.replace(/^F/, '') + '号发酵罐';
      return `<tr>
        <td><input type="checkbox" data-id="${id}" data-key="show"></td>
        <td>${nameToShow}</td>
        <td>${cap}</td>
        <td><input type="text" data-id="${id}" data-key="beer"></td>
        <td><input type="text" data-id="${id}" data-key="style"></td>
        <td><input type="text" data-id="${id}" data-key="abv"></td>
        <td><input type="text" data-id="${id}" data-key="ibu"></td>
        <td><input type="text" data-id="${id}" data-key="capacity"></td>
        <td><input type="text" data-id="${id}" data-key="temp"></td>
        <td><input type="date" data-id="${id}" data-key="start"></td>
        <td><input type="date" data-id="${id}" data-key="end"></td>
      </tr>`;
    }

    function saveData(){
      const inputs=document.querySelectorAll('input');
      const obj={};
      const history=loadHistory();

      inputs.forEach(input=>{
        const id=input.dataset.id,key=input.dataset.key;
        if(!id || !key) return;
        if(!obj[id]) obj[id]={};
        obj[id][key]=input.type==='checkbox'?input.checked:input.value;
        obj[id].capacity=obj[id].capacity || (id.startsWith('实验款')?'75L':'150L');

        // 保存历史记录：如果end时间小于今天，就写入历史
        if(key==='end' && input.value){
          const endDate=new Date(input.value).getTime();
          const now=Date.now();
          if(endDate < now && obj[id].beer){ 
            history.push({
              id:id,
              beer:obj[id].beer,
              style:obj[id].style,
              abv:obj[id].abv,
              ibu:obj[id].ibu,
              capacity:obj[id].capacity,
              start:obj[id].start,
              end:obj[id].end,
              timestamp:new Date().toISOString()
            });
          }
        }
      });

      localStorage.setItem(KEY,JSON.stringify(obj));
      localStorage.setItem(HISTORY_KEY,JSON.stringify(history));
      alert('保存成功！');
    }

    function loadAll(){
      try {return JSON.parse(localStorage.getItem(KEY))||{};}catch(e){return {};}
    }

    function loadHistory(){
      try {return JSON.parse(localStorage.getItem(HISTORY_KEY))||[];}catch(e){return [];}
    }

    function showHistory(){
      const history=loadHistory();
      if(!history.length){
        document.getElementById('historyTable').innerHTML='<p>暂无历史记录</p>';
      } else {
        let html='<table><tr><th>罐名</th><th>酒名</th><th>风格</th><th>ABV</th><th>IBU</th><th>容量</th><th>开始</th><th>结束</th><th>记录时间</th></tr>';
        history.forEach(h=>{
          html+=`<tr>
            <td>${h.id}</td>
            <td>${h.beer||'--'}</td>
            <td>${h.style||'--'}</td>
            <td>${h.abv||'--'}</td>
            <td>${h.ibu||'--'}</td>
            <td>${h.capacity||'--'}</td>
            <td>${h.start||'--'}</td>
            <td>${h.end||'--'}</td>
            <td>${h.timestamp||'--'}</td>
          </tr>`;
        });
        html+='</table>';
        document.getElementById('historyTable').innerHTML=html;
      }
      document.getElementById('historyModal').style.display='flex';
    }

    function closeHistory(){
      document.getElementById('historyModal').style.display='none';
    }

    window.onload=generateTable;
  </script>
</body>
</html>
