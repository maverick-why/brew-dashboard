<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>后台管理 · 时光酿造所</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #0b1220;
      color: #fff;
    }
    header {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      background: #111827;
    }
    .container {
      padding: 20px;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .primary {
      background: #3b82f6;
      color: #fff;
    }
    .danger {
      background: #ef4444;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #1f2937;
      padding: 8px;
      text-align: center;
    }
    input {
      width: 100%;
      padding: 6px;
      border-radius: 6px;
      border: none;
      background: #020617;
      color: #fff;
      text-align: center;
    }
  </style>
</head>
<body>

<header>后台管理 · 时光酿造所</header>

<div class="container">
  <div id="status" style="margin-bottom:10px;color:#f87171"></div>

  <button class="primary" onclick="loadFromRedis()">从共享数据源加载</button>
  <button class="primary" onclick="saveToRedis()">保存到共享数据源</button>

  <table>
    <thead>
      <tr>
        <th>显示</th>
        <th>罐名</th>
        <th>容量</th>
        <th>酒名</th>
        <th>风格</th>
        <th>ABV</th>
        <th>IBU</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ========================
   登录校验
======================== */

const adminPassword = prompt('请输入后台管理密码');

if (!adminPassword) {
  alert('未输入密码，禁止访问');
  location.href = '/';
}

/* ========================
   示例 & 状态
======================== */

let data = {
  tank1: { show: true, name: '1号发酵罐', capacity: '150L', beer: '港岛妹妹', style: 'HAZY IPA', abv: '6', ibu: '30' },
  tank2: { show: true, name: '2号发酵罐', capacity: '150L', beer: '重庆森林罐头', style: 'STOUT', abv: '9', ibu: '45' },
  tank3: { show: true, name: '3号发酵罐', capacity: '150L', beer: '丰收', style: 'Ale', abv: '5', ibu: '20' }
};

const statusEl = document.getElementById('status');

/* ========================
   渲染表格
======================== */

function render() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  Object.keys(data).forEach(key => {
    const t = data[key];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" ${t.show ? 'checked' : ''} onchange="data['${key}'].show=this.checked"></td>
      <td><input value="${t.name}" onchange="data['${key}'].name=this.value"></td>
      <td><input value="${t.capacity}" onchange="data['${key}'].capacity=this.value"></td>
      <td><input value="${t.beer}" onchange="data['${key}'].beer=this.value"></td>
      <td><input value="${t.style}" onchange="data['${key}'].style=this.value"></td>
      <td><input value="${t.abv}" onchange="data['${key}'].abv=this.value"></td>
      <td><input value="${t.ibu}" onchange="data['${key}'].ibu=this.value"></td>
    `;
    tbody.appendChild(tr);
  });
}

render();

/* ========================
   API 调用
======================== */

async function loadFromRedis() {
  statusEl.textContent = '';
  const res = await fetch('/api/load');
  const json = await res.json();
  if (Object.keys(json).length === 0) {
    statusEl.textContent = '共享数据源为空';
    return;
  }
  data = json;
  render();
}

async function saveToRedis() {
  statusEl.textContent = '';
  const res = await fetch('/api/save', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-admin-password': adminPassword
    },
    body: JSON.stringify(data)
  });

  if (!res.ok) {
    statusEl.textContent = '❌ 密码错误或无权限（Unauthorized）';
    return;
  }

  statusEl.style.color = '#34d399';
  statusEl.textContent = '✅ 已成功写入共享数据源（Redis）';
}
</script>

</body>
</html>
