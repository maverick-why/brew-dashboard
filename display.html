<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>DBBREW · Brewing Dashboard</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg0:#05070c;
      --bg1:#07101d;
      --card:#0f1a2a;
      --card2:#0b1423;
      --line:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.45);
      --accent:#3b82f6;
      --ok:#22c55e;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC","Microsoft YaHei", sans-serif;
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.14), transparent 55%),
        radial-gradient(900px 700px at 60% 120%, rgba(99,102,241,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, #000);
      padding: 14px 12px 28px;
    }
    a{color:inherit}

    .topbar{
      position:sticky; top:0; z-index:10;
      padding: 12px 12px 14px;
      border:1px solid var(--line);
      border-radius: calc(var(--r) + 4px);
      background: linear-gradient(180deg, rgba(15,26,42,.92), rgba(7,16,29,.70));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .brand{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
    }
    .brand h1{
      margin:0;
      font-size: 20px;
      line-height: 1.15;
      letter-spacing: .2px;
      font-weight: 850;
    }
    .brand h1 span{
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0;
    }
    .clock{
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      color: var(--muted);
      padding: 8px 10px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .subline{
      margin-top: 10px;
      color: var(--muted2);
      font-size: 12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .hint{
      display:flex; gap:8px; align-items:center;
    }
    .dot{
      width:7px;height:7px;border-radius:50%;
      background: var(--ok);
      box-shadow: 0 0 18px rgba(34,197,94,.35);
      flex:0 0 auto;
    }

    #cards{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 860px){
      body{padding:16px 18px 36px;}
      .brand h1{font-size: 26px;}
      #cards{grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px;}
    }
    @media (min-width: 1180px){
      #cards{grid-template-columns: repeat(3, minmax(0, 1fr));}
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(15,26,42,.92), rgba(11,20,35,.80));
      box-shadow: var(--shadow);
    }
    .card-hd{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .tank-title{
      min-width:0;
    }
    .tank-title .cn{
      font-size: 18px;
      font-weight: 850;
      line-height: 1.1;
      letter-spacing:.2px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tank-title .en{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .2px;
    }

    .badge{
      flex:0 0 auto;
      border-radius: 14px;
      border: 1px solid rgba(34,197,94,.55);
      background: linear-gradient(180deg, rgba(34,197,94,.24), rgba(34,197,94,.12));
      padding: 8px 10px;
      text-align:center;
      min-width: 108px;
      box-shadow: 0 0 26px rgba(34,197,94,.10);
    }
    .badge .t1{font-size: 12px; font-weight: 800; line-height:1.1;}
    .badge .t2{
      font-size: 15px;
      font-weight: 900;
      letter-spacing: .6px;
      margin-top: 3px;
      border-top:1px solid rgba(0,0,0,.22);
      padding-top: 4px;
      color: rgba(0,0,0,.80);
      background: rgba(255,255,255,.55);
      border-radius: 10px;
    }

    .card-bd{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 12px;
    }
    .field{
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      background: rgba(0,0,0,.16);
    }
    .field small{
      display:block;
      color: var(--muted2);
      font-size: 11px;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .field .val{
      font-size: 16px;
      font-weight: 850;
      line-height: 1.2;
      letter-spacing: .2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .field .val.mono{font-variant-numeric: tabular-nums;}

    .progress{
      padding: 0 14px 14px;
    }
    .bar{
      position:relative;
      height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,.90), rgba(99,102,241,.95));
    }
    .bar > span{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size: 10px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 1px 10px rgba(0,0,0,.65);
      font-variant-numeric: tabular-nums;
    }

    .empty{
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: calc(var(--r) + 6px);
      padding: 26px 16px;
      color: var(--muted);
      text-align:center;
      background: rgba(0,0,0,.12);
    }
    .empty b{color: var(--text)}
    footer{
      text-align:center;
      color: rgba(255,255,255,.35);
      margin-top: 18px;
      font-size: 12px;
      padding-bottom: 8px;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <h1>时光酿造所 · 重新定义新鲜 <span>/ Brewing Dashboard</span></h1>
      <div id="time" class="clock">--</div>
    </div>
    <div class="subline">
      <div class="hint"><span class="dot"></span><span>实时读取共享数据源（Redis）</span></div>
      <div class="hint"><span style="opacity:.6">提示：</span><span>下拉刷新 / 自动刷新</span></div>
    </div>
  </header>

  <main id="cards"></main>

  <footer>© 时光酿造所</footer>

  <script>
    const API_LOAD = "/api/load";
    const SECOND = 1000;
    const KEY_ORDER = ["F1","F2","F3","F4","F5","F6","F7","F8","F9","F10"];

    function pad2(n){ return String(n).padStart(2,"0"); }
    function nowText(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    }
    function setClock(){
      const el = document.getElementById("time");
      if(el) el.textContent = nowText();
    }
    setClock();
    setInterval(setClock, 1*SECOND);

    function fmtMD(iso){
      if(!iso) return "—";
      const d = new Date(iso);
      if(isNaN(d.getTime())) return "—";
      return `${d.getMonth()+1}月${d.getDate()}日`;
    }

    function calcProgress(start,end){
      const s = new Date(start).getTime();
      const e = new Date(end).getTime();
      const now = Date.now();
      if(isNaN(s) || isNaN(e) || e <= s) return 0;
      const p = (now - s) / (e - s) * 100;
      return Math.max(0, Math.min(100, Math.round(p)));
    }

    // 入罐天数：Day 1 从入罐当天起
    function fermentDays(start){
      if(!start) return 0;
      const s = new Date(start).getTime();
      const now = Date.now();
      if(isNaN(s) || now < s) return 0;
      return Math.floor((now - s) / 86400000) + 1;
    }

    // 稳定的“当前温度”：18.0~19.9 之间轻微波动（无后端温度传感器时用）
    function stableTemp(seed){
      const t = Date.now() / 600000; // 10min
      let h = 0;
      const str = String(seed || "x");
      for(let i=0;i<str.length;i++) h = (h*31 + str.charCodeAt(i)) % 997;
      const wave = Math.sin(t + h) * 0.45 + Math.sin(t*0.7 + h*0.3) * 0.22;
      const base = 18.6 + (h % 7) * 0.05;
      let v = base + wave;
      v = Math.max(18.0, Math.min(19.9, v));
      return v.toFixed(1) + "°C";
    }

    function pick(records){
      if(!records || typeof records !== "object") return [];
      const keys = Object.keys(records);
      const ordered = KEY_ORDER.filter(k => keys.includes(k)).concat(keys.filter(k => !KEY_ORDER.includes(k)));
      const list = [];
      for(const k of ordered){
        const r = records[k] || {};
        list.push({ id:k, ...r });
      }
      return list;
    }

    function render(records){
      const root = document.getElementById("cards");
      root.innerHTML = "";
      const list = pick(records).filter(x => x && x.show);

      if(list.length === 0){
        const div = document.createElement("div");
        div.className = "empty";
        div.innerHTML = `
          <div style="font-size:16px; font-weight:800; margin-bottom:8px;">暂无数据</div>
          <div>共享数据源为空或未勾选 <b>“展示”</b>。</div>
          <div style="margin-top:8px;">请在后台 <b>admin.html</b> 勾选并 <b>保存到共享数据源</b> 后刷新本页。</div>
        `;
        root.appendChild(div);
        return;
      }

      for(const r of list){
        const day = fermentDays(r.start);
        const prog = calcProgress(r.start, r.end);
        const temp = (r.temp && String(r.temp).trim()) ? String(r.temp).trim() : stableTemp(r.id);

        const el = document.createElement("section");
        el.className = "card";
        el.innerHTML = `
          <div class="card-hd">
            <div class="tank-title">
              <div class="cn">${escapeHtml(r.name || "发酵罐")}</div>
              <div class="en">Tank ${escapeHtml(String(r.id || ""))}</div>
            </div>
            <div class="badge" aria-label="status">
              <div class="t1">发酵中</div>
              <div class="t2">DAY ${day || 0}</div>
            </div>
          </div>

          <div class="card-bd">
            <div class="field"><small>酒名 / Name</small><div class="val">${escapeHtml(r.beer || "—")}</div></div>
            <div class="field"><small>风格 / Style</small><div class="val">${escapeHtml(r.style || "—")}</div></div>

            <div class="field"><small>度数 / ABV</small><div class="val mono">${escapeHtml(r.abv || "—")}</div></div>
            <div class="field"><small>苦度 / IBU</small><div class="val mono">${escapeHtml(r.ibu || "—")}</div></div>

            <div class="field"><small>容量 / Capacity</small><div class="val mono">${escapeHtml(r.capacity || "—")}</div></div>
            <div class="field"><small>当前温度 / Temp</small><div class="val mono">${escapeHtml(temp)}</div></div>

            <div class="field"><small>入罐时间 / Start</small><div class="val mono">${escapeHtml(fmtMD(r.start))}</div></div>
            <div class="field"><small>预计开罐 / End</small><div class="val mono">${escapeHtml(fmtMD(r.end))}</div></div>
          </div>

          <div class="progress">
            <div class="bar">
              <i style="width:${prog}%;"></i>
              <span>发酵进度 / Progress ${prog}%</span>
            </div>
          </div>
        `;
        root.appendChild(el);
      }
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    async function load(){
      try{
        const url = API_LOAD + "?t=" + Date.now();
        const res = await fetch(url, { cache:"no-store" });
        const data = await res.json().catch(()=> ({}));
        // 兼容：既可能直接返回 records，也可能是 {ok:true, data:{...}} 这种结构
        const records = (data && data.data && typeof data.data === "object") ? data.data : data;
        render(records);
      }catch(e){
        const root = document.getElementById("cards");
        root.innerHTML = `<div class="empty"><b>加载失败</b><div style="margin-top:8px;color:rgba(255,255,255,.55);">${escapeHtml(e?.message || String(e))}</div></div>`;
      }
    }

    load();
    // 自动刷新：30 秒
    setInterval(load, 30*SECOND);

    // iOS/微信：回到前台时刷新一次
    document.addEventListener("visibilitychange", () => {
      if(!document.hidden) load();
    }, { passive:true });
  </script>
</body>
</html>
