<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Brewing Dashboard</title>

<style>
:root{
  --bg0:#070b12;
  --bg1:#0b1220;
  --card:#111a2a;
  --text:#eaf0ff;
  --sub:rgba(234,240,255,.65);
  --green:#4ade80;
  --yellow:#ffcc00;
  --pink:#ff5c8a;
  --blue1:#7bd3ff;
  --blue2:#2b80ff;
  --r:18px;
}

*{box-sizing:border-box}
html,body{margin:0;background:var(--bg1);color:var(--text);font-family:-apple-system,ui-sans-serif;}

header{
  padding:18px 0 10px;
  text-align:center;
  position:sticky;top:0;
  background:rgba(10,16,28,.75);
  backdrop-filter:blur(10px);
  z-index:20;
  border-bottom:1px solid rgba(255,255,255,.1);
}
.logo{
  height:60px;
  margin:0 auto 10px;
}
.h-time{
  font-size:14px;
  font-weight:700;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  display:inline-block;
  background:rgba(255,255,255,.05);
}

main{padding:14px;}

.list{
  display:flex;
  flex-direction:column;
  gap:14px;
}

.card{
  background:var(--card);
  border-radius:var(--r);
  padding:16px;
  position:relative;
  border:1px solid rgba(255,255,255,.08);
}

.ribbon{
  position:absolute;
  top:12px;
  left:-32px;
  width:120px;
  transform:rotate(-45deg);
  background:var(--pink);
  color:white;
  text-align:center;
  font-weight:900;
  padding:4px 0;
  letter-spacing:.6px;
  font-size:12px;
}

.topRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.tankNum{
  font-size:28px;
  font-weight:900;
}

.infoName{
  font-size:20px;
  font-weight:800;
}

.tag{
  background:rgba(255,255,255,.08);
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  font-weight:600;
  margin-left:6px;
}

.badge{
  padding:8px 14px;
  border-radius:14px;
  font-weight:900;
  text-align:center;
  font-size:14px;
  min-width:90px;
  color:#000;
}
.badge.green{background:var(--green);}
.badge.yellow{background:var(--yellow);}

.row{
  display:flex;
  justify-content:space-between;
  margin:6px 0;
  font-size:14px;
}

.progressWrap{
  margin-top:10px;
}
.progressLine{
  height:10px;
  background:rgba(255,255,255,.1);
  border-radius:999px;
  position:relative;
  overflow:hidden;
}
.progressLine i{
  height:100%;
  display:block;
  background:linear-gradient(90deg,var(--blue1),var(--blue2));
  width:0%;
  transition:width .8s;
}
.progressText{
  margin-top:6px;
  text-align:center;
  font-size:12px;
  color:var(--sub);
}

.dateRow{
  display:flex;
  justify-content:space-between;
  margin-top:6px;
  font-size:13px;
  color:var(--sub);
}

@media(max-width:560px){
  .logo{height:48px;}
  .tankNum{font-size:24px;}
  .infoName{font-size:18px;}
  .badge{font-size:13px;}
}
</style>
</head>

<body>
<header>
  <img src="/logo.png" class="logo" />
  <div class="h-time" id="time">--</div>
</header>

<main>
  <div id="list" class="list"></div>
</main>

<script>
const LOAD_URL="/api/load";
let temperatureMap={};

/* ========== 时间显示 ========== */
function pad(n){return String(n).padStart(2,"0");}
function tick(){
  const d=new Date();
  time.textContent=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} `
                  +`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
setInterval(tick,1000); tick();

/* ========== 温度随机波动 ========== */
function updateTemps(){
  for(const key in temperatureMap){
    let t=temperatureMap[key];
    let delta=(Math.random()<0.5?-1:1)*(Math.random()<0.5?0.1:0.2);
    t+=delta;
    if(t<18)t=18;
    if(t>19.9)t=19.9;
    temperatureMap[key]=parseFloat(t.toFixed(1));
  }
  render(lastData);
}
setInterval(updateTemps,5000);

/* ========== 工具函数 ========== */
function daysSince(start){
  if(!start)return null;
  const s=new Date(start);
  if(isNaN(s)) return null;
  return Math.floor((Date.now()-s)/86400000)+1;
}
function formatMD(d){
  if(!d)return"--";
  const x=new Date(d);
  if(isNaN(x))return"--";
  return `${x.getMonth()+1}月${x.getDate()}日`;
}
function calcProgress(s,e){
  s=new Date(s); e=new Date(e);
  if(isNaN(s)||isNaN(e)||e<=s) return 0;
  let p=(Date.now()-s)/ (e-s)*100;
  return Math.max(0,Math.min(100,Math.round(p)));
}

/* 自动状态：≥95% 显示即将开罐 */
function getStatus(progress){
  return progress>=95 ? "ready" : "ferment";
}

function safe(v){return v?String(v):"--";}

/* ========== 渲染 ========== */
let lastData={};

function render(data){
  lastData=data;
  const list=document.getElementById("list");
  list.innerHTML="";

  const arr=Object.entries(data)
      .map(([id,row])=>({id,...row}))
      .filter(x=>x.show);

  arr.sort((a,b)=>a.id.localeCompare(b.id));

  arr.forEach(item=>{
    if(!temperatureMap[item.id]){
      temperatureMap[item.id]=18+(Math.random()*1.9);
    }

    const progress=calcProgress(item.start,item.end);
    const status=getStatus(progress);
    const day=daysSince(item.start);

    const badgeClass = status==="ready"?"yellow":"green";
    const badgeText  = status==="ready"?"即将开罐":"发酵中";
    const dayText    = day?`DAY ${day}`:"";

    const card=document.createElement("div");
    card.className="card";

    card.innerHTML=`
      ${item.limited?`<div class="ribbon">Limited</div>`:""}

      <div class="topRow">
        <div>
          <div class="tankNum">${item.id.replace("F","")}</div>
          <div class="infoName">${safe(item.beer)}</div>
          <span class="tag">${safe(item.style)}</span>
        </div>

        <div class="badge ${badgeClass}">
          ${badgeText}<br>${dayText}
        </div>
      </div>

      <div class="row">
        <div>ABV：${safe(item.abv)}%</div>
        <div>IBU：${safe(item.ibu)}</div>
      </div>

      <div class="row">
        <div>产量：${safe(item.capacity)}</div>
        <div>温度：${temperatureMap[item.id].toFixed(1)}°C</div>
      </div>

      <div class="dateRow">
        <div>入罐：${formatMD(item.start)}</div>
        <div>开罐：${formatMD(item.end)}</div>
      </div>

      <div class="progressWrap">
        <div class="progressLine">
          <i style="width:${progress}%;"></i>
        </div>
        <div class="progressText">${progress}%</div>
      </div>
    `;
    list.appendChild(card);
  });
}

/* ========== 加载数据 ========== */
async function load(){
  try{
    const res=await fetch(LOAD_URL,{cache:"no-store"});
    const data=await res.json();
    render(data);
  }catch(e){
    console.error(e);
    render({});
  }
}

load();
setInterval(load,15000);
</script>
</body>
</html>
