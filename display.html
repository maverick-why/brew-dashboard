<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>时光酿造所 · 发酵监控 / Brewing Dashboard</title>
<style>
:root{--bg:#0d1117;--card-bg:#161b22;--accent:#ff5c8a;--text:#fff;--sub:#aaa;--progress-bg:#2c313c}
body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',sans-serif;background:var(--bg);color:var(--text)}
header{background:#1b2230;text-align:center;padding:14px 0;font-size:22px;font-weight:800;letter-spacing:1px;box-shadow:0 2px 8px rgba(0,0,0,.3);position:sticky;top:0;z-index:20}
#time{display:block;font-size:14px;color:var(--sub);margin-top:6px}
main{display:flex;flex-wrap:wrap;gap:20px;padding:20px;justify-content:center}
.card{background:var(--card-bg);border-radius:20px;width:320px;box-shadow:0 8px 20px rgba(0,0,0,.4);overflow:hidden;position:relative;display:flex;flex-direction:column}
.card-header{background:#222836;padding:14px 18px;font-size:18px;font-weight:800;text-align:center;position:relative;min-height:50px;line-height:1.2}
.card-header span{display:block}
.status{position:absolute;right:10px;top:50%;transform:translateY(-50%);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:800;color:#000;white-space:nowrap;text-align:center}
.status span{display:block;line-height:1.2}
.status-fermenting{background:#4ade80;animation:breathing 2s ease-in-out infinite}
@keyframes breathing{0%,100%{box-shadow:0 0 0 0 rgba(74,222,128,.5)}50%{box-shadow:0 0 12px 4px rgba(74,222,128,.3)}}
.card-content{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:10px 12px;font-size:14px;min-height:240px}
.card-field{display:flex;flex-direction:column}
.card-field small{font-size:12px;color:var(--sub);margin-bottom:2px;text-align:left;line-height:1.2}
.card-field .value{font-size:14px;word-break:break-word;text-align:left}
.progress-wrapper{grid-column:1 / -1;display:flex;flex-direction:column;gap:4px;margin-top:12px;align-items:center}
.progress-title{font-size:12px;color:var(--sub);text-align:center}
.progress-container{width:100%;background:var(--progress-bg);border-radius:999px;overflow:hidden;height:12px;position:relative}
.progress-bar{height:100%;background:linear-gradient(90deg,#7bd3ff,#2b80ff);width:0%;transition:width 1s ease;border-radius:999px}
.progress-label{position:absolute;width:100%;text-align:center;font-size:11px;color:var(--text);line-height:12px;top:0;left:0}
.empty{color:var(--sub);font-size:14px;padding:40px 20px;text-align:center}
</style>
</head>
<body>
<header>
  时光酿造所 · 重新定义新鲜 / Brewing Dashboard
  <span id="time"></span>
</header>

<main id="cards"></main>

<footer style="text-align:center; padding:14px 0; font-size:14px; color:#aaa; background:#1b2230;">
  © 时光酿造所
</footer>

<script>
  const tankTempState = {}; // 每个罐独立温度状态
  const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));

  function nowStr(){
    const d=new Date();
    const pad=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function fmtDate(d){
    if(!d) return '--';
    const t=new Date(d);
    if(isNaN(t)) return '--';
    return `${t.getMonth()+1}月${t.getDate()}日`;
  }

  function calcProgress(start,end){
    const s=new Date(start).getTime();
    const e=new Date(end).getTime();
    const now=Date.now();
    if(isNaN(s)||isNaN(e)||e<=s) return 0;
    let p=(now-s)/(e-s)*100;
    return Math.max(0, Math.min(100, Math.round(p)));
  }

  async function apiLoad(){
    const r = await fetch("/api/load", {cache:"no-store"});
    const j = await r.json();
    if(!r.ok) throw new Error(j?.error || "load failed");
    return j || {};
  }

  function stepTemp(key, baseStr){
    const base = Number(baseStr || 18.2);
    if(!tankTempState[key]){
      tankTempState[key] = clamp(base, 18.0, 19.9);
    }
    // 每秒小幅波动：-0.3 ~ +0.3
    const delta = (Math.random()*0.6 - 0.3);
    let next = tankTempState[key] + delta;
    // 让它“围绕 base”一点点回拉，避免飘走
    next = next + (base - next) * 0.08;

    next = clamp(next, 18.0, 19.9);
    tankTempState[key] = next;
    return next.toFixed(1);
  }

  function render(model){
    const main=document.getElementById('cards');
    main.innerHTML='';
    const keys = Object.keys(model||{});
    const visible = keys.filter(k => model[k] && model[k].show);

    if(visible.length===0){
      main.innerHTML = `<div class="empty">暂无数据（共享数据源为空或未勾选“展示”）。<br/>请在后台 admin.html 填写并保存。</div>`;
      return;
    }

    for(const id of visible){
      const d = model[id] || {};
      const p = calcProgress(d.start, d.end);
      const temp = stepTemp(id, d.baseTemp);

      const title = d.tankLabel || (id.startsWith("LAB") ? "实验罐" : "发酵罐");

      const html=`
      <div class="card">
        <div class="card-header">
          <span>${title}</span>
          <span class="status status-fermenting"><span>发酵中</span><span>Fermenting</span></span>
        </div>
        <div class="card-content">
          <div class="card-field"><small>酒名 / Name</small><span class="value">${d.beer||'--'}</span></div>
          <div class="card-field"><small>风格 / Style</small><span class="value">${d.style||'--'}</span></div>

          <div class="card-field"><small>度数 / ABV</small><span class="value">${d.abv||'--'}</span></div>
          <div class="card-field"><small>苦度 / IBU</small><span class="value">${d.ibu||'--'}</span></div>

          <div class="card-field"><small>容量 / Capacity</small><span class="value">${d.capacity||'--'}</span></div>
          <div class="card-field"><small>当前温度 / Temp</small><span class="value">${temp}℃</span></div>

          <div class="card-field"><small>入罐时间 / Start</small><span class="value">${fmtDate(d.start)}</span></div>
          <div class="card-field"><small>预计开罐 / End</small><span class="value">${fmtDate(d.end)}</span></div>

          <div class="progress-wrapper">
            <div class="progress-title">发酵进度 / Progress</div>
            <div class="progress-container">
              <div class="progress-bar" style="width:${p}%"></div>
              <div class="progress-label">${p}%</div>
            </div>
          </div>
        </div>
      </div>`;
      main.insertAdjacentHTML('beforeend', html);
    }
  }

  // 头部时间：每秒刷新
  setInterval(()=>{ document.getElementById('time').textContent = nowStr(); }, 1000);
  document.getElementById('time').textContent = nowStr();

  // 数据：每5秒拉一次共享数据源
  async function refreshData(){
    try{
      const data = await apiLoad();
      render(data);
    }catch(e){
      document.getElementById('cards').innerHTML =
        `<div class="empty">加载失败：${e.message}<br/>请稍后再试</div>`;
    }
  }
  refreshData();
  setInterval(refreshData, 5000);
</script>
</body>
</html>
